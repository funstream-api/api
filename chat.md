API Чата
------

1. [**Протокол взаимодействия**](#Протокол-взаимодействия)
2. [**Оповещение сервера**](#Оповещение-сервера)
  - [`WS` `P` `/chat/login` Подписаться на события пользователя](#Подписаться-на-события-пользователя)
  - [`WS` `A` `/chat/logout` Отписаться от событий пользователя](#Отписаться-от-событий-пользователя)
  - [`WS` `P` `/chat/join` Присоединится к каналу](#Присоединится-к-каналу)
  - [`WS` `P` `/chat/leave` Покинуть канал](#Покинуть-канал)
  - [`WS` `P` `/chat/history` История канала](#История-канала)
  - [`WS` `A` `/chat/publish` Отправить сообщение](#Отправить-сообщение)
3. [**Оповещение клиента**](#Оповещение-клиента)
  - [`WS` `P` `/chat/message` Новое сообщение](#Новое-сообщение)
  - [`WS` `P` `/chat/message/remove` Удаление сообщения](#Удаление-сообщения)
  - [`WS` `P` `/chat/user/join` Присоединение к каналу](#Присоединение-к-каналу)
  - [`WS` `P` `/chat/user/leave` Отсоединение от канала](#Отсоединение-от-канала)
4. [**Каналы чата, текущие и запланированные**](#Каналы-чата-текущие-и-запланированные)
5. [**Типы сообщений**](#Типы-сообщений)


Протокол взаимодействия
--------------------------

Клиент и сервер обмениваются событиями через [`socket.io`](http://socket.io/).  
При соединении значении опции `transports` может быть только 'websocket'.  
Все события для сервера получают ответ через коллбек.  
Примеры взаимодействия клиента можно посмотреть на сайте [`socket.io`](http://socket.io/).

[Примеры взаимодействия для разных языков](chat-client-examples.md)


Оповещение сервера
---------------------

Все параметры должны отправляться с данными тех типов, что указаны в документации. В случае неверного типа сервер может ничего не ответить на запрос.

##### Формат ответа
```js
{
    status: <string>, // 'ok' при успешном выполнении, 'error' при ошибке
    result: <array|obj|null>
}
```
Далее в блоке ответ у методов указано содержимое поля `result` в случае успешного выполнения.  
В случае ошибки обязательно присутствует объект `result` и содержит поле `message` с текстом ошибки.


#### Подписаться на события пользователя
#####[`WS` `P` `/chat/login`](http://funstream.tv/chat/login)
**запрос**
```js
{
    token: <string>, jwt токен*
}
```
**ответ**
```js
{}
```
*[`jwt.io`](http://jwt.io/)  
Подписывает на события, относящиеся к пользователю.


#### Отписаться от событий пользователя
#####[`WS` `A` `/chat/logout`](http://funstream.tv/chat/logout/)
**запрос**
```js
{}
```
**ответ**
```js
{}
```
Отписывает от событий, относящихся к пользователю.


#### Присоединится к каналу
#####[`WS` `P` `/chat/join`](http://funstream.tv/chat/join)
**запрос**
```js
{
    channel: <string|null>  // Идентификатор канала, см. раздел 4
}
```
**ответ**
```js
{}
```
Присоединяет к событиям выбранного канала, если канал не указан - присоединяет к общему.


#### Покинуть канал
#####[`WS` `P` `/chat/leave`](http://funstream.tv/chat/leave)
**запрос**
```js
{
    channel: <string|null> // Идентификатор канала, см. раздел 4
}
```
**ответ**
```js
{}
```
Отсоединяет от событий выбранного канала.


#### История канала
#####[`WS` `P` `/chat/history`](http://funstream.tv/chat/history)
**запрос**
```js
{
    channel: <string|null>, // Идентификатор канала, см. раздел 4
    amount: <int>, // Необходимое количество сообщений для выборки
    query: <obj|null> { // Дополнительные условия выборки, см. описание ниже
        conditions: <array> [ // Список условий
            <obj> { // Условие
                field: <string>, // Имя поля
                operation: <string>, // Тип сравнения
                value: <array>, // Массив значений
                glue: <string>, // Тип соединения в запросе
            },
            ...
        ],
        groups: <array> [ // Список групп условий, такие же объекты как `query` произвольной вложенности
            <obj>,
            ...
        ],
        glue: <string> // Тип соединения, для верхнего уровня всегда 'and'
    }
}
```
**ответ**
```js
[
    <obj>, // Объект из события клиента /chat/message
    ...
]
```
Параметр запроса `query` позволяет уточнить выборку дополнительными условиями по разным полям. Формат объектов `groups` совпадает с форматом этого объекта. Для `query` тип соединения всегда `and`.  
Группы это условия из `conditions` внутри скобок с указанным в `glue` соединителем перед ними. Тип соединения первого элемента в массиве `conditions` игнорируется.  
Доступные значения полей условия
- `field` - [id, from, to, type]
  - **id** - идентификатор сообщения
  - **from** - идентификатор автора сообщения
  - **to** - идентификатор пользователя, к которому обращаются
  - **type** - тип сообщения, см. раздел 5
- `operation` - [in, not in, =, <>, <, >]
- `value` - обязательно строка, для одиночного значения указывать внутри массива, например ['1']
- `glue` - [and, or], только в нижнем регистре

Примеры `query` и итоговый кусок запроса который они дадут
- сообщения только указанного пользователя и обращения к нему
```
{
    conditions: [],
    groups: [
        {
            conditions: [
                {field: 'from', operation: '=', value: [1], glue: 'or'},
                {field: 'to', operation: '=', value: [1], glue: 'or'}
            ],
            groups: [],
            glue: 'and'
        }
    ],
    glue: 'and'
}
```
```sql
AND ((`from` = 1 OR `to` = 1))
```
- без сообщений указанных пользователей(игнор), включая обращения
```
{
    conditions: [
        {field: 'from', operation: 'not in', value: [1, 2, 3], glue: 'and'},
        {field: 'to', operation: 'not in', value: [1, 2, 3], glue: 'and'}
    ],
    groups: [],
    glue: 'and'
}
```
```sql
AND (`from` not in (1, 2, 3) AND `to` not in (1, 2, 3))
```
- оба случая вместе
```
{
    conditions: [
        {field: 'from', operation: 'not in', value: [1, 2, 3], glue: 'and'},
        {field: 'to', operation: 'not in', value: [1, 2, 3], glue: 'and'}
    ],
    groups: [
        {
            conditions: [
                {field: 'from', operation: '=', value: [1], glue: 'or'},
                {field: 'to', operation: '=', value: [1], glue: 'or'}
            ],
            groups: [],
            glue: 'and'
        }
    ],
    glue: 'and'
}
```
```sql
AND (`from` not in (1, 2, 3) AND `to` not in (1, 2, 3) AND (`from` = 1 OR `to` = 1))
```


#### Отправить сообщение
#####[`WS` `A` `/chat/publish`](http://funstream.tv/chat/publish)
**запрос**
```js
{
    channel: <string>, // Идентификатор канала, см. раздел 4
    from: <obj> {
        id: <int>, // Идентификатор пользователя
        name: <string> // Имя пользователя
    }
    to: <obj|null> {
        id: <int>, // Идентификатор пользователя
        name: <string> // Имя пользователя
    }
    text: <string> // Текст сообщения
}
```
**ответ**
```js
{}
```
Будет работать только после `/chat/login`



Оповещение клиента
---------------------

События, которые получает подключившийся к сокету клиент.  
Некоторые могут трабовать предварительной аутентификации через метод [`/chat/login`](#Подписаться-на-события-пользователя).


#### Новое сообщение
#####[`WS` `P` `/chat/message`](http://funstream.tv/chat/message)
```js
{
    id: <int>,  // Идентификатор сообщения
    channel: <string>, // Идентификатор канала, см. раздел 4
    from: {
        id: <int>, // Идентификатор пользователя
        name: <string>, // Имя пользователя
        namecolor: <int> // Идентификатор цвета имени пользователя
    },
    to: <obj|null>, // Идентификатор и имя пользователя к которому обращаются
    text: <string>, // Текст сообщения
    time: <string>, // Дата-время сообщения (временно, потом будет временная метка)
    type: <string> // Тип сообщения, см. раздел 5
}
```
В данный момент из-за синхронизации и нек-х упрощений со стороны сервера, на каждое сообщение может приходить 2 таких события с одинаковыми данными. Для защиты от дубликатов фильтруйте данные по идентификатору сообщения. После правки способа синхронизации с чатом ск2тв эта проблема пропадёт.  
Приходит для всех сообщений в текущий канал пользователя.  
Если пользователь аутентифицирован, то для всех сообщений, адресованных текущему пользователю для любого канала.


#### Удаление сообщения
#####[`WS` `P` `/chat/message/remove`](http://funstream.tv/chat/message/remove)
```js
{
    id: <int>, // Идентификатор сообщения
    channel: <string> // Идентификатор канала, см. раздел 4
}
```
Приходит для сообщений, которые должны быть удалены из чата.


#### Присоединение к каналу
#####[`WS` `P` `/chat/user/join`](http://funstream.tv/chat/user/join)
```js
{}
```
Приходит для каждого пользователя подключившегося к каналу, после` /chat/join`.


#### Отсоединение от канала
#####[`WS` `P` `/chat/user/leave`](http://funstream.tv/chat/user/leave)
```js
{}
```
Приходит для каждого пользователя покинувшего канал.


Каналы чата, текущие и запланированные
--------------------------------------
- `main` Мэин чат(общий)
- `admin` Админка(доступ у модераторов, саппортов)
- `stream/<streamer_id>` Стрим
- `goodgame.ru/<streamer_id>` Сообщения с гудгейма, если у стримера активен этот плеер
- `twitch.tv/<streamer_id>` Сообщения с твича, если у стримера активен этот плеер
- `support/<id>` Вопрос к хелпдеску
- Запланированные
  - `private/<from_id>/<to_id>` Личные сообщения
  - `notifications/<user_id>` Системные уведомления для пользователя


Типы сообщений
--------------
- `message` Обычное сообщение(включая другие стримсервисы)
- `system` Системные сообщения
- `fastdonate` Микродонат
- `donate` Донат, на данный момент включает в себя и сообщения связанные с челенджами
- `subscribe` Подписка на мастер стримера
- `announce` Анонсы стримов